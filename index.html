<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ビデオチャット</title>
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <div class="round_div">
      <input type="text" placeholder="ルーム名" id="js-name">
      <button id="js-join-trigger">参加</button>
      <button id="js-leave-trigger">退室</button>

      <section id="section2">
        <div id="container_video" style="border: solid black 1px; border-color: #990099;"></div>
      </section>

    </div>
    <script src="//cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
    <script src="../share/key.js"></script>

    <script>
      const Peer = window.Peer;

      (async function main() {
        const video_width = 480;
        const video_height = parseInt(video_width / 1.333333333);
        const video_cols = 2;
        const video_rows = 2;
        const section2 = document.getElementById("section2");
        section2.style.width = (video_width * video_cols) + "px";
        section2.style.height = (video_height * video_rows) + "px";
        const section3 = document.getElementById("section3");
        // ビデオ表示用コンテナの設定
        const container = document.getElementById('container_video');


        // テスト
        const roomName = document.getElementById('js-name');
        const roomId = roomName.text;
        const joinTrigger = document.getElementById('js-join-trigger');
        const leaveTrigger = document.getElementById('js-leave-trigger');
        const sdkSrc = document.querySelector('script[src*=skyway]');

//        meta.innerText = `UA: ${navigator.userAgent}SDK: ${sdkSrc ? sdkSrc.src : 'unknown'}`.trim();

        const localStream = await navigator.mediaDevices.getUserMedia(
            { audio: true,
              video: {
                 width : {ideal:320},
                 height: {ideal:240},
              },
            }
          ).catch(console.error);

        // ローカルストリームの作成   Render local stream
          const newVideo = document.createElement('video');
          newVideo.width = video_width;
          newVideo.height = video_height;
//          messages.textContent += '=== video_width:'+video_width+'video_height:'+video_height+' ===\n';
          newVideo.style.border = 'solid black 1px';
          newVideo.style.margin = '2px';
          newVideo.muted = true;
          newVideo.srcObject = localStream;
          newVideo.playsInline = true;
          newVideo.setAttribute('data-peer-id', 'myself');
          container.appendChild(newVideo);
          await newVideo.play().catch(console.error);

        // eslint-disable-next-line require-atomic-updates
        const peer = (window.peer = new Peer({key: window.__SKYWAY_KEY__,debug: 3,}));

        // ジョインハンドラの登録   Register join handler
        joinTrigger.addEventListener('click', () => {
          // Note that you need to ensure the peer has connected to signaling server
          // before using methods of peer instance.
          if (!peer.open) {
            return;
          }

          // ルームに参加
          const room = peer.joinRoom(roomId, {
            mode: 'sfu',
            stream: localStream,
          });

          room.once('open', () => {
//            messages.textContent += '=== 参加しました ===\n';
          });
          room.on('peerJoin', peerId => {
//            messages.textContent += `=== ${peerId}が参加 ===\n`;
          });

          // ルームに参加した新しいpeerのためにリモートストリームを作成  Render remote stream for new peer join in the room
          room.on('stream', async stream => {
            const newVideo = document.createElement('video');
            newVideo.width = video_width;
            newVideo.height = video_height;
            newVideo.style.border = 'solid black 1px';
            newVideo.style.margin = '2px';
            newVideo.srcObject = stream;
            newVideo.playsInline = true;
            // mark peerId to find it later at peerLeave event
            newVideo.setAttribute('data-peer-id', stream.peerId);
            container.appendChild(newVideo);
            await newVideo.play().catch(console.error);
          });

          // データの受信処理
          room.on('data', ({ data, src }) => {
            // Show a message sent to the room and who sent
//            messages.textContent += `${src}: ${data}\n`;
          });

          // 他メンバーの退室処理   for closing room members
          room.on('peerLeave', peerId => {
            const remoteVideo = container.querySelector(`[data-peer-id="${peerId}"]`);
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.srcObject = null;
            remoteVideo.remove();
//            messages.textContent += `=== ${peerId}が退室 ===\n`;
          });

          // 自分の退室処理    for closing myself
          room.once('close', () => {
            sendTrigger.removeEventListener('click', onClickSend);
//            messages.textContent += '=== 退室しました ===\n';
            Array.from(container.children).forEach(remoteVideo => {
              // 自分のビデオ以外をコンテナから削除
              const id = remoteVideo.getAttribute('data-peer-id');
//              messages.textContent += '=== ID:'+id+' ===\n';
              if( id != 'myself'){
                remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
                remoteVideo.remove();
              }
            });
          });

          sendTrigger.addEventListener('click', onClickSend);
          leaveTrigger.addEventListener('click', () => room.close(), { once: true });

          function onClickSend() {
            // 全てのpeerにメッセージを送信    Send message to all of the peers in the room via websocket
//            room.send(localText.value);
//            messages.textContent += `${peer.id}: ${localText.value}\n`;
//            localText.value = '';
          }
        });

        peer.on('error', console.error);
      })();
    </script>
  </body>
</html>
