<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ビデオチャット</title>
    <style>
      .noscroll {
          overflow: hidden;
      }
      .video-div {
          position: relative;
          vertical-align: middle;
      }
      .fukidashi {
          display: none;
          width: 200px;
          position: absolute;
          top: 0;
          padding: 2px;
          border-radius: 0px;
          background: blue;
          color: #fff;
          font-weight: bold;
      }
      .video {
          position: relative;
      }
      .video:hover + .fukidashi {
          display: block;
      }
    </style>
  </head>
  <body class='noscroll'>
    <div>
      <div id='header'>
        <label>参加者名：</label>
        <input type='text' placeholder='自分の表示名を入力' id='js-my-name'></input>
        <label>ルーム名：</label>
        <input type='text' value='TestRoom' id='js-room-name'></input>
        <button id='js-enter-leave'>入室</button>
        <button id='js-screen-share' disabled>画面共有開始</button>
        <label id='js-message'></label>
      </div>
      <div>
        <div id='common' style='width:0px; height:0px; float:left;'></div>
        <div id='container' style='border:1px solid blue; float:left;'></div>
      </div>
    </div>
    <script src="//cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
    <script src="./key.js"></script>
    <script>
      var common_width;
      var common_height;
      var container_width;
      var container_height;
      var div_cols = 1;
      var div_rows = 1;
      var div_width;
      var div_height;
      var myPeerId, myScreenPeerId;
      var members = 0;
      var memberName = [];
      var haveDisplayMedia = false;
      (function () {
        // 画面ロード時の処理登録
        window.addEventListener( 'load', function() {
          const header_height = document.getElementById('header').clientHeight;
          common_with = 0;
          common_height = window.innerHeight-header_height-20;
          common.style.width = common_width + 'px';
          common.style.height = common_height + 'px';
          container_width = window.innerWidth-20;
          container_height = common_height;
          container.style.width = container_width + 'px';
          container.style.height = container_height + 'px';
          div_width = Math.floor((container_width-(2*div_cols)) / div_cols);
          div_height = Math.floor((container_height-(2*div_rows)) / div_rows);
        }, false );
        // 画面リサイズ時の処理登録
        window.addEventListener( 'resize', function() {
          const header_height = document.getElementById('header').clientHeight;
          if( haveDisplayMedia ){
            // 共有画面　表示時の処理
            common_width = Math.floor((window.innerWidth-20)*0.8);
            common_height = window.innerHeight-header_height-20;
            common.style.width = common_width + 'px';
            common.style.height = common_height + 'px';
            Array.from(common.children).forEach(targetDiv => {
              Array.from(targetDiv.children).forEach(elm => {
                if( elm.className == 'video' ){
                  changeDivVideoSize(common_width, common_height, targetDiv.id);
                }
              });
            });
            container_width = window.innerWidth-common_width-20;
            container_height = common_height;
            container.style.width = container_width + 'px';
            container.style.height = container_height + 'px';
            div_width = Math.floor((container_width-(2*div_cols)) / div_cols);
            div_height = Math.floor((container_height-(2*div_rows)) / div_rows);
            Array.from(container.children).forEach(targetDiv => {
              Array.from(targetDiv.children).forEach(elm => {
                if( elm.className == 'video' ){
                  changeDivVideoSize(div_width, div_height, targetDiv.id);
                }
              });
            });
          } else {
            // 共有画面　非表示時の処理
            common_with = 0;
            common_height = window.innerHeight-header_height-20;
            container_width = window.innerWidth-20;
            container_height = common_height;
            container.style.width = container_width + 'px';
            container.style.height = container_height + 'px';
            div_width = Math.floor((container_width-(2*div_cols)) / div_cols);
            div_height = Math.floor((container_height-(2*div_rows)) / div_rows);
            for(let i = 0; i < memberName.length; i++){
              changeDivVideoSize(div_width, div_height, memberName[i].peerId);
            }
          }
        }, false );
      }) ();
      // videoサイズの設定＆変更
      function makeVideoContainer(pContainer, pDiv, pWidth, pHeight, pStream, pLocal) {
        // divの設定
        pDiv.className = 'video-div';
        if( pLocal ){
          pDiv.id = 'myself';
        } else {
          pDiv.id = pStream.peerId;
        }
        pDiv.align = 'center';
        pDiv.style.border ='1px solid gray';
        pDiv.style.width = pWidth + 'px';
        pDiv.style.height = pHeight + 'px';
        pDiv.style.float = 'left';
        pContainer.appendChild(pDiv);
        // videoの作成
        const newVideo = document.createElement('video');
        newVideo.className = 'video';
        SetChangeVideoSize(pWidth, pHeight, newVideo);
        if( pLocal ){
          newVideo.muted = true;
        }
        newVideo.srcObject = pStream;
        newVideo.playsInline = true;
        pDiv.appendChild(newVideo);
        return newVideo;
      }
      // videoサイズの設定＆変更
      function SetChangeVideoSize(pWidth, pHeight, pElement) {
        const video_height = Math.floor(pWidth / 1.33333333);
        if( pHeight > video_height ){
          pElement.width = pWidth;
          pElement.height = video_height;
          pElement.style.top = Math.floor((pHeight - video_height) / 2) + 'px';
        } else {
          pElement.width = Math.floor(pHeight * 1.33333333);
          pElement.height = pHeight;
          pElement.style.top = '0px';
        }
      }
      // divサイズとvideoサイズの変更
      function changeDivVideoSize(pWidth, pHeight, pPeerId) {
        const div = document.getElementById(pPeerId);
        div.style.width = pWidth + 'px';
        div.style.height = pHeight + 'px';
        Array.from(div.children).forEach(elm => {
          if( elm.className == 'video' ){
            SetChangeVideoSize(pWidth, pHeight, elm);
          }
        });
      }
      // ビデオコンテナ再作成
      function remakeContainer(joinMembers) {
        const videos = [];
        const ps = [];
        const header_height = document.getElementById('header').clientHeight;
        if( !haveDisplayMedia ){
          // 共有画面なし時の処理
          switch(true){
          case joinMembers == 1:
            div_cols = 1; div_rows = 1; break;
          case joinMembers == 2:
            div_cols = 2; div_rows = 1; break;
          case joinMembers > 2 && joinMembers <= 4:
            div_cols = 2; div_rows = 2; break;
          case joinMembers > 4 && joinMembers <= 6:
            div_cols = 3; div_rows = 2; break;
          case joinMembers > 6 && joinMembers <= 9:
            div_cols = 3; div_rows = 3; break;
          case joinMembers > 9 && joinMembers <= 12:
            div_cols = 4; div_rows = 3; break;
          case joinMembers > 12 && joinMembers <= 16:
            div_cols = 4; div_rows = 4; break;
          default:
            div_cols = 5; div_rows = 4;
          }
          common_width = 0;
          common_height = window.innerHeight-header_height-20;
          common.style.border = 'none';
          common.style.width = common_width + 'px';
          common.style.height = common_height + 'px';
          container_width = window.innerWidth-20;
          container_height = common_height;
          container.style.width = container_width + 'px';
          container.style.height = container_height + 'px';
          div_width = Math.floor((container_width-(2*div_cols)) / div_cols);
          div_height = Math.floor((container_height-(2*div_rows)) / div_rows);
          Array.from(container.children).forEach(targetDiv => {
            if( targetDiv.id != myPeerId ){
              // コンテナから全てのdivを削除
              Array.from(targetDiv.children).forEach(elm => {
                if( elm.className == 'video' ){
                  videos.push(elm);
                } else {
                  ps.push(elm);
                }
                elm.remove();
              });
              targetDiv.remove();
            } else {
              changeDivVideoSize(div_width, div_height, myPeerId);
            }
          });
          // 退避したdivを再作成
          for( let i=0; i<videos.length ; i++ ){
              const newDiv = document.createElement("div");
              newDiv.className = 'video-div';
              newDiv.id = memberName[i+1].peerId;
              newDiv.align = 'center';
              newDiv.style.border ='1px solid gray';
              newDiv.style.width = div_width + 'px';
              newDiv.style.height = div_height + 'px';
              newDiv.style.float = 'left';
              SetChangeVideoSize(div_width, div_height, videos[i]);
              newDiv.appendChild(videos[i]);
              newDiv.appendChild(ps[i]);
              container.appendChild(newDiv);
          }
        } else {
          // 共有画面あり時の処理
          switch(true){
          case joinMembers <= 5:
            div_cols = 1; div_rows = 5; break;
          case joinMembers > 5 && joinMembers <= 10:
            div_cols = 1; div_rows = 10; break;
          default:
            div_cols = 2; div_rows = 10;
          }
          common_width = Math.floor((window.innerWidth-20)*0.8);
          common_height = window.innerHeight-header_height-20;
          common.style.width = common_width + 'px';
          common.style.height = common_height + 'px';
          common.style.border = '1px solid blue';
          container_width = window.innerWidth-common_width-20;
          container_height = common_height;
          container.style.width = container_width + 'px';
          container.style.height = container_height + 'px';
          div_width = Math.floor((container_width-(2*div_cols)) / div_cols);
          div_height = Math.floor((container_height-(2*div_rows)) / div_rows);
          Array.from(container.children).forEach(targetDiv => {
            changeDivVideoSize(div_width, div_height, targetDiv.id);
          });
        }
      }

      // メイン処理
      (async function main() {
        var roomMain, roomScreen;
        const myName = document.getElementById('js-my-name');
        const roomName = document.getElementById('js-room-name');
        const EnterLeave = document.getElementById('js-enter-leave');
        const ScreenShare = document.getElementById('js-screen-share');
        const localStream = await navigator.mediaDevices.getUserMedia(
            { audio: true,
//              video: true,
              video: {
                 width : {ideal:640},
                 height: {ideal:480},
                 frameRate: { ideal: 10, max: 15 },
              },
            }
        ).catch(console.error);

        // SkyWayに接続
        const peerMain = (window.peer = new Peer({key: window.__SKYWAY_KEY__,debug: 3,}));
        const peerScreen = (window.peer = new Peer({key: window.__SKYWAY_KEY__,debug: 3,}));
        // ローカルストリーム用divの作成
        const newDiv = document.createElement("div");
        newVideo = makeVideoContainer(container, newDiv, div_width, div_height, localStream, true);
        const newP = document.createElement('p');
        newP.className = 'fukidashi';
        newP.innerText = 'ルームに未参加です';
        newDiv.appendChild(newP);
        memberName.push({peerId:'myself', name:''});
        members ++;
        myPeerId = 'myself';
        await newVideo.play().catch(console.error);

        // 入退室処理
        EnterLeave.addEventListener('click', () => {
          if (!peerMain.open) {
            alert('SkyWayと接続できません。');
            return;  // perrが未接続の時終了
          }
          if( document.getElementById('js-my-name').value == '' ){
            alert('参加者名を入力してください。');
            return;
          }
          myPeerId = peerMain.id;
          if( EnterLeave.innerText == '入室' ){
            const myDiv = document.getElementById('myself');
            myDiv.id = myPeerId;
            Array.from(myDiv.children).forEach(elm => {
               if( elm.className == 'fukidashi' ){
                 elm.innerText = document.getElementById('js-my-name').value;
               }
            });
            for( let i=0; i<members; i++ ){
              if( memberName[i].peerId == 'myself' ){
                memberName[i].peerId = myPeerId;
                memberName[i].name = myName.value;
                break;
              }
            }
            // ルームに参加
            roomMain = peerMain.joinRoom(roomName.value, {
              mode: 'sfu',
              stream: localStream,
            });
            EnterLeave.innerText = '退室';
          }else{
            EnterLeave.innerText = '入室';
            roomMain.close(),{once:true};
          }
          //***** roomオープン時の処理 *****//
          roomMain.once('open', () => {
            roomMain.send(JSON.stringify({myName:myName.value}));
            ScreenShare.disabled = false;
          });
          //***** ルームに参加した新しいpeerのためにリモートストリームを作成 *****//
          roomMain.on('stream', async stream => {
            let newVideo;
            const isDisplayMedia = stream.getAudioTracks().length==0?true:false;
            if( !haveDisplayMedia && isDisplayMedia ){
              haveDisplayMedia = true;
              if( ScreenShare.innerText == '画面共有開始' ){
                ScreenShare.disabled = true;
              }
            }
            remakeContainer(++members);
            const newDiv = document.createElement("div");
            if( isDisplayMedia ){
              // 共有画面
              newVideo = makeVideoContainer(common, newDiv, common_width, common_height, stream, false);
            } else {
              // ビデオ画面
              newVideo = makeVideoContainer(container, newDiv, div_width, div_height, stream, false);
              const newP = document.createElement('p');
              newP.className = 'fukidashi';
              newP.innerText = '未定';
              for( let i=0; i<memberName.length; i++ ){
                if( memberName[i].peerId == stream.peerId ){
                  newP.innerText = memberName[i].name;
                }
              }
              if( newP.innerText == '未定' ){
                roomMain.send(JSON.stringify({WhatYorName:''}));
              }
              newDiv.appendChild(newP);
            }
            await newVideo.play().catch(console.error);
          });
          //***** 自分の退室処理 *****//
          roomMain.once('close', () => {
            Array.from(container.children).forEach(targetDiv => {
              if( targetDiv.id == myPeerId){
                // 自分のコンテナを初期化
                targetDiv.id = 'myself';
                myPeerId = 'myself';
                Array.from(targetDiv.children).forEach(elm => {
                  if( elm.className == 'fukidashi' ){
                    elm.innerText = 'ルームに未参加です';
                  }
                });
              } else {
                // 自分以外のコンテナのエレメントを削除
                Array.from(targetDiv.children).forEach(elm => {
                  if( elm.className == 'video' ){
                    elm.srcObject.getTracks().forEach(track => track.stop());
                    elm.srcObject = null;
                  }
                  elm.remove();
                });
                targetDiv.remove();
              }
            });
            if( haveDisplayMedia ){
              // 共有画面使用時の処理
              const targetDiv = document.getElementById('common');
              Array.from(targetDiv.children).forEach(elm => {
                if( elm.className == 'video' ){
                  elm.srcObject.getTracks().forEach(track => track.stop());
                  elm.srcObject = null;
                }
                elm.remove();
              });
              haveDisplayMedia = false;
            }
            // 自分のPeerId以外をすべて削除
            memberName.splice(1);
            memberName[0].peerId = 'myself';
            members = 1;
            remakeContainer(members);
            ScreenShare.disabled = true;
          });
          //***** 他メンバーの退室処理 *****//
          roomMain.on('peerLeave', peerId => {
            // 退室したメンバーのコンテナを削除
            const targetDiv = document.getElementById(peerId);
            Array.from(targetDiv.children).forEach(elm => {
              if( elm.className == 'video' ){
                const isDisplayMedia = elm.srcObject.getAudioTracks().length==0?true:false;
                if( haveDisplayMedia && isDisplayMedia ){
                  haveDisplayMedia = false;
                  if( ScreenShare.innerText == '画面共有開始' ){
                    ScreenShare.disabled = false;
                  }
                }
                elm.srcObject.getTracks().forEach(track => track.stop());
                elm.srcObject = null;
              }
              elm.remove();
            });
            targetDiv.remove();
            // 退室したPeerIdをmemberNameから削除
            for( let i=1; i<memberName.length ; i++ ){
              if( memberName[i] == peerId ){
                memberName.splice(i, 1);
              }
            }
            remakeContainer(--members);
          });
          //***** データの受信処理 *****//
          roomMain.on('data', ({ data, src }) => {
            const peerId = `${src}`;
            const recdata = JSON.parse(`${data}`);
            if( typeof recdata.myName != "undefined"){
              memberName.push({peerId:peerId, name:recdata.myName});
            }
            if( typeof recdata.WhatYorName != "undefined"){
              roomMain.send(JSON.stringify({AnswerMyName:document.getElementById('js-my-name').value}));
            }
            if( typeof recdata.AnswerMyName != "undefined"){
              let not_exist = true;
              for( let i=0; i<memberName.length; i++ ){
                if( memberName[i].peerId == peerId ){
                  not_exist = false;
                  break;
                }
              }
              if( not_exist ){
                memberName.push({peerId:peerId, name:recdata.AnswerMyName});
                const targetDiv = document.getElementById(peerId);
                Array.from(targetDiv.children).forEach(elm => {
                  if( elm.className == 'fukidashi' ){
                    elm.innerText = recdata.AnswerMyName;
                  }
                });
              }
            }
          });
        });
        //***** 画面共有処理 *****//
        ScreenShare.addEventListener('click', async () => {
          myScreenPeerId = peerScreen.id;
          if( ScreenShare.innerText == '画面共有開始' ){
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            // ルームに参加
            roomScreen = peerScreen.joinRoom(roomName.value, {
              mode: 'sfu',
              stream: screenStream,
            });
            ScreenShare.innerText = '画面共有終了';
          } else {
            roomScreen.close(),{once:true};
            ScreenShare.innerText = '画面共有開始';
          }
        });
      })();
    </script>
  </body>
</html>

